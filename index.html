<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Mekan YÃ¶netim Paneli PRO v3.5</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --primary: #2563eb; --dark: #1e293b; --bg: #f1f5f9; --red: #ef4444; --green: #16a34a; --orange: #f59e0b; }
  body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #334155; }
  .app-container { display: flex; height: 100vh; }
  .sidebar { width: 240px; background: var(--dark); color: white; padding: 25px; display: flex; flex-direction: column; }
  .content { flex: 1; padding: 40px; overflow-y: auto; }
  .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  input, select { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
  button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 2px; }
  .btn-main { background: var(--primary); color: white; width: 100%; }
  .btn-nav { background: #334155; color: white; margin-bottom: 8px; text-align: left; width: 100%; }
  .btn-danger { background: var(--red); color: white; }
  .btn-success { background: var(--green); color: white; }
  .btn-edit { background: var(--orange); color: white; }
  .center-box { width: 400px; margin: 80px auto; background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  .list-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
  .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 2000; }
</style>
</head>
<body>

<div id="loading" class="loading-overlay"><h3>YÃ¼kleniyor...</h3></div>

<div id="admin-panel" class="container mt-4" style="display:none;">
<ul class="nav nav-tabs" id="adminTabs" role="tablist">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#staff-tab">Personeller</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#inventory-tab">Stok</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#finance-tab">Maliyetler</a></li>
</ul>

<div class="tab-content border p-3 bg-light">
  <div id="staff-tab" class="tab-pane fade show active">
    <h4>Personel & Performans</h4>
    <div id="personel-listesi-tablo" class="row"></div>
  </div>
  
  <div id="inventory-tab" class="tab-pane fade">
    <h4>Depo / Stok</h4>
    <div id="stok-listesi-tablo"></div>
  </div>
</div>
</div>


<div id="loginScreen" class="center-box" style="display:none;">
  <h2 style="color: var(--primary)">Yani Etkinlik</h2>
  <input type="email" id="email" placeholder="E-posta">
  <input type="password" id="password" placeholder="Åifre">
  <button class="btn-main" onclick="girisYap()">GiriÅŸ Yap</button>
  <button class="btn-success" style="width:100%; margin-top:10px;" onclick="kayitOl()">KayÄ±t Ol</button>
  <button class="btn-nav" style="color: var(--primary); margin-top: 10px; width: 100%; text-align: center;" onclick="loginEkranDegistir('personel')">
     Personel GiriÅŸi Yap
</button>

</div>
<div id="personelLoginScreen" class="center-box" style="display:none;">
  <h2 style="color: var(--purple)">Personel GiriÅŸi</h2>
  <p>Sisteme kayÄ±tlÄ± telefon numaranÄ±zla giriÅŸ yapÄ±n.</p>
  <input type="tel" id="p_login_tel" placeholder="5xx xxx xxxx">
  <button class="btn-succes" style="color:var(--green); width:100%;" onclick="personelGirisYap()">Etkinliklerimi GÃ¶r</button>
  <button class="btn-main" onclick="loginEkranDegistir('admin')">YÃ¶netici GiriÅŸine DÃ¶n</button>
</div>

<div id="personelPanel" class="app-container" style="display:none; flex-direction:column; padding:40px;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2 id="p_selam">Merhaba, ...</h2>
    <button class="btn-danger" style="padding:50px 75px; font-size: 35px;" onclick="location.reload()">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
  <hr>
  <h3>ğŸ“… GÃ¶revli OlduÄŸun Etkinlikler</h3>
  <div id="p_gorev_listesi"></div>
  <div id="p_duyuru_alani" style="margin-top: 45px;">
  </div>
  <div class="card" style="margin-top:50px; border-top: 4px solid #6366f1;">
    <div style="display: flex; gap: 15px; margin-bottom: 40px;">
        <button onclick="chatModuDegistir('ozel')" id="btn-ozel" style="flex:1; padding:50px; cursor:pointer; border:none; border-radius:5px; background:#6366f1; color:white;">ğŸ‘¤ YÃ¶netici</button>
        <button onclick="chatModuDegistir('grup')" id="btn-grup" style="flex:1; padding:50px; cursor:pointer; border:none; border-radius:5px; background:#94a3b8; color:white;">ğŸ‘¥ Etkinlik Grubu</button>
        <select id="p-chat-grup-secici" style="display:none; width:100%; padding:16px; margin-top:5px; border-radius:5px; border:1px solid #ddd;" onchange="mesajlariYukle()">
        </select>
    
    </div>
    
    <div id="p-chat-penceresi" style="height: 250px; overflow-y: auto; background: #f8fafc; padding: 45px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 10px;">
        <p style="text-align:center; color:gray; font-size:30px; margin-top:100px;">Mesajlar yÃ¼kleniyor...</p>
    </div>
    
    <div style="display: flex; gap: 5px;">
        <input type="text" id="p-mesaj-input" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;" placeholder="Mesaj yazÄ±n...">
        <button onclick="mesajGonder()" style="padding:30px 60px; background:#6366f1; color:white; border:none; border-radius:8px; cursor:pointer;">GÃ¶nder</button>
    </div>
</div>


</div>

<div id="mekanSecimScreen" class="center-box" style="display:none;">
  <h3>Mekan YÃ¶netimi</h3>
  <div class="card" style="box-shadow: none; border: 1px solid #eee;">
    <input type="text" id="yeni_mekan_adi" placeholder="Yeni Mekan AdÄ±">
    <button class="btn-success" style="width:100%" onclick="mekanEkle()">+ Yeni Mekan Ekle</button>
  </div>
  <hr>
  <label>SeÃ§ili Mekan:</label>
  <select id="sel_mekan_listesi"></select>
  <div style="display: flex; gap: 5px; margin-top: 10px;">
    <button class="btn-edit" style="flex:1" onclick="mekanDuzenle()">AdÄ± DÃ¼zenle</button>
    <button class="btn-main" style="flex:2" onclick="mekanOnayla()">GiriÅŸ Yap</button>
  </div>
</div>
<div id="ai-chat-window" style="position:fixed; bottom:80px; right:20px; width:350px; height:450px; background:white; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.2); display:none; flex-direction:column; z-index:2000; overflow:hidden; border: 1px solid #ddd;">
  <div style="background:var(--primary); color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between;">
    <span>ğŸ¤– AkÄ±llÄ± Asistan</span>
    <span style="cursor:pointer" onclick="document.getElementById('ai-chat-window').style.display='none'">âœ–</span>
  </div>
  <div id="ai-messages" style="flex:1; overflow-y:auto; padding:15px; background:#f9f9f9; font-size:14px;">
    <div style="margin-bottom:10px; color:#555;"><i>Merhaba! Sana nasÄ±l yardÄ±mcÄ± olabilirim? (Ã–rn: "YarÄ±nki dÃ¼ÄŸÃ¼ne Ahmet'i ekle" veya "Bu ayki toplam personel maliyetim ne?")</i></div>
  </div>
  <div style="padding:10px; border-top:1px solid #eee; display:flex;">
    <input type="text" id="ai-input" placeholder="Bir komut yaz..." style="flex:1; border:1px solid #ddd; padding:8px; border-radius:5px;">
    <button onclick="aiSorguGonder()" style="margin-left:5px; background:var(--primary); color:white; border-radius:5px;">GÃ¶nder</button>
  </div>
</div>

<button onclick="chatAcKapat()" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%; background:var(--primary); color:white; font-size:20px; z-index:2000; box-shadow:0 4px 10px rgba(0,0,0,0.3); border:none; cursor:pointer;">ğŸ¤–</button>

<div id="stok" class="page" style="display:none;">
<h1>ğŸ“¦ Depo / Stok Durumu</h1>
<div class="card">
  <div style="display: flex; gap: 10px;">
    <input type="text" id="s_ad" placeholder="ÃœrÃ¼n AdÄ± (Ã–rn: Volkan)">
    <input type="number" id="s_miktar" placeholder="Mevcut Adet">
    <button class="btn-success" style="width:150px;" onclick="stokEkle()">+ Ekle</button>
  </div>
</div>
<div id="s_liste"></div>
</div>

<div id="app" class="app-container" style="display:none;">
  <div class="sidebar">
    <h3 id="aktif-mekan-label" style="color: var(--orange);">Mekan</h3>
    <button class="btn-nav" onclick="sayfaGoster('dashboard')">ğŸ“Š Dashboard</button>
    <button class="btn-nav" onclick="sayfaGoster('personel')">ğŸ‘¥ Personel Havuzu</button>
    <button class="btn-nav" onclick="sayfaGoster('stok')">ğŸ“¦ Stok YÃ¶netimi</button>
    <button class="btn-nav" onclick="sayfaGoster('etkinlik')">ğŸ“… Etkinlikler</button>
    <button class="btn-nav" onclick="sayfaGoster('atama')">ğŸ”— Personel Ata</button>
    <button class="btn-nav" onclick="sayfaGoster('duyuru')" style="display: block; width: 100%; background: #334155;">ğŸ“¢ Duyuru & Bildirimler</button>
    <button class="nav-btn" onclick="sayfaGoster('mesajlar')">ğŸ’¬ Mesajlar</button>
    <button class="btn-main" style="background: #25D366; margin-top: 10px;" onclick="whatsappListeOlustur()">
      ğŸŸ¢ WhatsApp Listesi Kopyala
  </button>  
    <button class="btn-danger" style="margin-top: 20px;" onclick="mekanSil()">ğŸ—‘ï¸ MekanÄ± Sil</button>
    <button class="nav-btn" onclick="sayfaGoster('yardim')">ğŸ’¡ YardÄ±m & KullanÄ±m</button>
    <button class="btn-nav" style="margin-top: auto; background:#475569;" onclick="cikisYap()">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
  </div>

  <div class="content">
    <div id="dashboard" class="page">
      <h1>Dashboard</h1>
      <div style="display: flex; gap: 20px;">
        <div class="card" style="flex:1; text-align: center;"> <h2 id="stat-personel">0</h2> <p>Personel</p> </div>
        <div class="card" style="flex:1; text-align: center;"> <h2 id="stat-etkinlik">0</h2> <p>Etkinlik</p> </div>
      </div>
    </div>

    <div id="personel" class="page" style="display:none;">
      <h1>Personel Havuzu</h1>
      <div class="card">
        <input type="text" id="p_isim" placeholder="Ad Soyad">
        <input type="text" id="p_tel" placeholder="Telefon">
        <input type="number" id="p_yevmiye" placeholder="Yevmiye (TL)">
        <button class="btn-success" onclick="personelEkle()">+ Ekle</button>
        <div class="card" style="background: #e2e8f0;">
          <input type="text" id="p_ara" placeholder="ğŸ” Personel Ä°smiyle Ara..." oninput="personelFiltrele()">
        </div>        
      </div>
      <div id="p_liste"></div>
    </div>
    <div id="page-mesajlar" class="page" style="display:none;">
      <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px; height: 80vh;">
          
          <div style="background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; overflow-y: auto;">
              <h3 style="font-size: 16px; margin-bottom: 15px;">Sohbetler</h3>
              <div id="admin-chat-listesi">
                  </div>
          </div>
  
          <div style="background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column;">
              <div id="admin-chat-baslik" style="padding: 15px; border-bottom: 1px solid #eee; font-weight: bold;">Bir sohbet seÃ§in</div>
              <div id="admin-chat-penceresi" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;"></div>
              <div style="padding: 15px; display: flex; gap: 10px;">
                  <input type="text" id="admin-mesaj-input" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="MesajÄ±nÄ±z...">
                  <button onclick="adminMesajGonder()" style="padding:10px 20px; background:#6366f1; color:white; border:none; border-radius:8px;">GÃ¶nder</button>
              </div>
          </div>
  
      </div>
  </div>
  

<div id="page-yardim" class="page" style="display:none; padding:20px;">
    <h2>ğŸš€ Sistem v1 KullanÄ±m KÄ±lavuzu</h2>
    <hr>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px;">
        <div class="card">
            <h3>ğŸ“¢ Duyuru & MesajlaÅŸma</h3>
            <ul>
                <li><b>Duyurular:</b> TÃ¼m personele aynÄ± anda gider, personelin ekranÄ±nda anÄ±nda belirir.</li>
                <li><b>Ã–zel Mesaj:</b> Personel listesinden birini seÃ§ip direkt yazÄ±ÅŸabilirsin.</li>
                <li><b>Etkinlik GruplarÄ±:</b> Bir etkinliÄŸe atadÄ±ÄŸÄ±n herkes o grubun iÃ§inde otomatik toplanÄ±r.</li>
            </ul>
        </div>
        <div class="card">
            <h3>ğŸ“… Etkinlik YÃ¶netimi</h3>
            <ul>
                <li>Etkinlik oluÅŸtururken tarih ve saat girmeyi unutma.</li>
                <li><b>Personel Atama:</b> Etkinlik detayÄ±ndan personelleri seÃ§ip "Ata" dersen, gÃ¶rev onlarÄ±n paneline dÃ¼ÅŸer.</li>
            </ul>
        </div>
    </div>
</div>

  

    <div id="etkinlik" class="page" style="display:none;">
      <h1>Etkinlikler</h1>
      <div class="card">
        <input type="text" id="e_ad" placeholder="Etkinlik AdÄ±">
        <div style="display: flex; gap: 10px;">
          <input type="date" id="e_tarih" style="flex: 2;">
          <input type="text" id="e_saat" placeholder="Saat" style="flex: 1;">
        </div>
        <button class="btn-success" onclick="etkinlikEkle()">Etkinlik OluÅŸtur</button>
      </div>
      <div id="e_liste"></div>
    </div>
    <div id="page-duyuru" class="page" style="display:none;">
      <h2 style="margin-bottom: 20px;">ğŸ“¢ Duyuru ve Bildirim Merkezi</h2>
  
      <div class="card" style="border-left: 5px solid #ef4444; background: #fff; padding: 20px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <h3 style="color: #ef4444; margin-top: 0;">âš ï¸ Gelen Ä°ptal Bildirimleri</h3>
          <p style="font-size: 13px; color: #666;">Personellerin "GelemeyeceÄŸim" dediÄŸi gÃ¶revler burada listelenir.</p>
          <div id="iptal-listesi" style="margin: 15px 0; min-height: 50px;">
              <p style="color:gray; font-style: italic;">YÃ¼kleniyor...</p>
          </div>
          <button class="btn-main" style="background: #374151; width: auto; font-size: 13px;" onclick="bildirimleriTemizle()">Hepsini Okundu Ä°ÅŸaretle</button>
      </div>
  
      <div class="card" style="border-left: 5px solid #8b5cf6; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <h3 style="color: #8b5cf6; margin-top: 0;">ğŸ“£ Yeni Duyuru YayÄ±nla</h3>
          <textarea id="duyuru_metni" rows="4" placeholder="TÃ¼m personellere iletilecek mesajÄ± yazÄ±n..." 
                    style="width:100%; padding:12px; border: 1px solid #ddd; border-radius: 8px; font-family: sans-serif; resize: none;"></textarea>
          <button class="btn-main" style="background: #8b5cf6; margin-top: 15px; width: 100%;" onclick="duyuruYayinla()">ğŸš€ Duyuruyu Personellere GÃ¶nder</button>
      </div>
  </div>
  

    <div id="atama" class="page" style="display:none;">
      <h1>GÃ¶revlendirme</h1>
      <div class="card">
        <select id="sel_etkinlik" onchange="atamaListesiniYukle()"></select>
        <select id="sel_personel"></select>
        <input type="text" id="a_gorev" placeholder="GÃ¶revi">
        <button class="btn-main" onclick="atamaYap()">Ata</button>
      </div>
      <div id="atama_liste"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://bmaromecrtmiiafeadsi.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtYXJvbWVjcnRtaWlhZmVhZHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE1NDMsImV4cCI6MjA4NzE3NzU0M30.cgIcd1hfc5G8kxp3hNFMaUovrKL2uZvcQ86uW4deUyY";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentMekanId = null;
let currentUser = null;

// OTURUM KONTROLÃœ (Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda)
window.onload = async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (session) {
    currentUser = session.user;
    await mekanListesiniGetir();
  } else {
    document.getElementById("loginScreen").style.display = "block";
  }
  document.getElementById("loading").style.display = "none";
};

// AUTH
async function kayitOl() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabaseClient.auth.signUp({ email, password });
  if (error) alert(error.message); else alert("KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapabilirsiniz.");
}

async function girisYap() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);
  currentUser = data.user;
  document.getElementById("loginScreen").style.display = "none";
  mekanListesiniGetir();
}

async function cikisYap() {
  await supabaseClient.auth.signOut();
  location.reload();
}

// MEKAN
async function mekanListesiniGetir() {
  const { data: mekanlar } = await supabaseClient.from("mekanlar").select("*").eq("sahip_id", currentUser.id);
  document.getElementById("mekanSecimScreen").style.display = "block";
  const sel = document.getElementById("sel_mekan_listesi");
  sel.innerHTML = "";
  mekanlar?.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.mekan_adi}</option>`);
}

async function mekanEkle() {
  const ad = document.getElementById("yeni_mekan_adi").value;
  if(!ad) return alert("Mekan adÄ± girin!");
  const { error } = await supabaseClient.from("mekanlar").insert([{ mekan_adi: ad, sahip_id: currentUser.id }]);
  if(!error) { document.getElementById("yeni_mekan_adi").value = ""; mekanListesiniGetir(); }
}

async function mekanDuzenle() {
  const sel = document.getElementById("sel_mekan_listesi");
  const yeniAd = prompt("Yeni mekan adÄ±:", sel.options[sel.selectedIndex].text);
  if(yeniAd) {
    await supabaseClient.from("mekanlar").update({ mekan_adi: yeniAd }).eq("id", sel.value);
    mekanListesiniGetir();
  }
}

function mekanOnayla() {
  const sel = document.getElementById("sel_mekan_listesi");
  if(!sel.value) return alert("Mekan seÃ§in!");
  currentMekanId = sel.value;
  document.getElementById("mekanSecimScreen").style.display = "none";
  document.getElementById("app").style.display = "flex";
  document.getElementById("aktif-mekan-label").innerText = sel.options[sel.selectedIndex].text;
  verileriYukle();
  stoklariYukle();
  sayfaGoster('dashboard');
}

async function mekanSil() {
  if(confirm("TÃœM MEKAN VERÄ°LERÄ° SÄ°LÄ°NECEK! Emin misiniz?")) {
    await supabaseClient.from("mekanlar").delete().eq("id", currentMekanId);
    location.reload();
  }
}

// GENEL VERÄ°LER

async function personelEkle() {
  const { error } = await supabaseClient.from("personeller").insert([{
    isim: document.getElementById("p_isim").value,
    telefon: document.getElementById("p_tel").value,
    yevmiye: document.getElementById("p_yevmiye").value,
    mekan_id: currentMekanId
  }]);
  if(!error) { 
    document.getElementById("p_isim").value = ""; 
    document.getElementById("p_tel").value = "";
    document.getElementById("p_yevmiye").value = "";
    verileriYukle(); 
  }
}

async function etkinlikEkle() {
  const adInput = document.getElementById("e_ad");
  const tarihInput = document.getElementById("e_tarih");

  const ad = adInput.value.trim();
  const tarih = tarihInput.value;

  if (!ad || !tarih) {
    return alert("LÃ¼tfen etkinlik adÄ±nÄ± ve tarihini girin!");
  }

  if (!currentMekanId) {
    return alert("Mekan ID bulunamadÄ±, lÃ¼tfen sayfayÄ± yenileyip tekrar giriÅŸ yapÄ±n.");
  }

  // Supabase'e ekle
  const { data, error } = await supabaseClient
    .from("etkinlikler")
    .insert([
      { 
        etkinlik_turu: ad, 
        tarih: tarih, 
        mekan_id: currentMekanId 
      }
    ])
    .select();

  if (error) {
    console.error("Etkinlik ekleme hatasÄ±:", error);
    alert("Hata oluÅŸtu: " + error.message);
  } else {
    // Formu temizle
    adInput.value = "";
    tarihInput.value = "";
    
    // Listeleri gÃ¼ncelle
    alert("Etkinlik baÅŸarÄ±yla eklendi!");
    verileriYukle();
  }
}


async function verileriYukle() {
  const { data: pData } = await supabaseClient.from("personeller").select("*").eq("mekan_id", currentMekanId);
  const pList = document.getElementById("p_liste");
  const pSel = document.getElementById("sel_personel");
  pList.innerHTML = ""; pSel.innerHTML = "";
  // script.js iÃ§indeki verileriYukle fonksiyonunun ilgili kÄ±smÄ±
// verileriYukle fonksiyonu iÃ§indeki pData?.forEach kÄ±smÄ±nÄ± bununla deÄŸiÅŸtir:
pList.innerHTML = ""; 
pData?.forEach(p => {
  pList.innerHTML += `
    <div class="list-item" style="border-left: 5px solid var(--primary); margin-bottom: 10px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
      <div>
        <strong>${p.isim}</strong> <br>
        <small>ğŸ’° ${p.yevmiye} TL | â­ Puan: <b id="puan-${p.id}">${p.puan || 5}</b></small> <br>
        <small style="color: #64748b;">ğŸ“ ${p.telefon || 'Telefon girilmemiÅŸ'}</small>
      </div>
      <div style="display: flex; gap: 5px; align-items: center;">
        <button class="btn-edit" style="padding: 5px 10px;" onclick="personelDuzenle('${p.id}', '${p.isim}', ${p.yevmiye}, '${p.telefon || ''}')">âœï¸ DÃ¼zenle</button>
        
        <button class="btn-success" style="padding: 5px 10px;" onclick="puanDegistir('${p.id}', 1)">+</button>
        <button class="btn-danger" style="padding: 5px 10px;" onclick="puanDegistir('${p.id}', -1)">-</button>
        
        <button class="btn-danger" style="padding: 5px 10px; background: #94a3b8;" onclick="personelSil('${p.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  pSel.innerHTML += `<option value="${p.id}">${p.isim}</option>`;
});



  const { data: eData } = await supabaseClient.from("etkinlikler").select("*").eq("mekan_id", currentMekanId);
  const eList = document.getElementById("e_liste");
  const eSel = document.getElementById("sel_etkinlik");
  eList.innerHTML = ""; eSel.innerHTML = "";
  eData?.forEach(e => {
    eList.innerHTML += `<div class="list-item">ğŸ“… ${e.etkinlik_turu} - ${e.tarih} <button class="btn-danger" onclick="etkinlikSil('${e.id}')">Sil</button></div>`;
    eSel.innerHTML += `<option value="${e.id}">${e.etkinlik_turu}</option>`;
  });

  document.getElementById("stat-personel").innerText = pData?.length || 0;
  document.getElementById("stat-etkinlik").innerText = eData?.length || 0;
}

async function personelSil(id) {
  if(confirm("Silinsin mi?")) { await supabaseClient.from("personeller").delete().eq("id", id); verileriYukle(); }
}

async function etkinlikSil(id) {
  if(confirm("Silinsin mi?")) { await supabaseClient.from("etkinlikler").delete().eq("id", id); verileriYukle(); }
}

async function atamaYap() {
  const eId = document.getElementById("sel_etkinlik").value;
  const pId = document.getElementById("sel_personel").value;
  const gorev = document.getElementById("a_gorev").value;

  if (!eId || !pId) return alert("LÃ¼tfen etkinlik ve personel seÃ§in!");

  // 1. KONTROL: Bu personel bu etkinlikte zaten var mÄ±?
  const { data: mevcutAtama } = await supabaseClient
    .from("gorev_atamalari")
    .select("id")
    .eq("etkinlik_id", eId)
    .eq("personel_id", pId);

  if (mevcutAtama && mevcutAtama.length > 0) {
    return alert("Hata: Bu personel bu etkinlikte zaten gÃ¶revli!");
  }

  // 2. KONTROL: Personel aynÄ± tarihte baÅŸka bir etkinlikte mi?
  // Ã–nce seÃ§ilen etkinliÄŸin tarihini alalÄ±m
  const { data: seciliEtkinlik } = await supabaseClient
    .from("etkinlikler")
    .select("tarih")
    .eq("id", eId)
    .single();

  // Personelin o tarihteki diÄŸer gÃ¶revlerine bakalÄ±m
  const { data: cakismaVarMi } = await supabaseClient
    .from("gorev_atamalari")
    .select("id, etkinlikler(etkinlik_turu, tarih)")
    .eq("personel_id", pId)
    .filter("etkinlikler.tarih", "eq", seciliEtkinlik.tarih);

  if (cakismaVarMi && cakismaVarMi.length > 0) {
    const etkinlikAdi = cakismaVarMi[0].etkinlikler.etkinlik_turu;
    if(!confirm(`UYARI: Bu personel aynÄ± tarihte "${etkinlikAdi}" etkinliÄŸinde de gÃ¶revli. Yine de atamak istiyor musunuz?`)) {
      return;
    }
  }

  // Her ÅŸey tamamsa atamayÄ± yap
  const { error } = await supabaseClient.from("gorev_atamalari").insert([{
    etkinlik_id: eId,
    personel_id: pId,
    gorev: gorev,
    mekan_id: currentMekanId
  }]);

  if (!error) {
    document.getElementById("a_gorev").value = "";
    atamaListesiniYukle();
  } else {
    alert("Atama hatasÄ±: " + error.message);
  }
}


async function atamaListesiniYukle() {
  const eid = document.getElementById("sel_etkinlik").value;
  const aList = document.getElementById("atama_liste");
  
  if(!eid) {
    aList.innerHTML = `<div style="color:#64748b; padding:20px; text-align:center;">ğŸ” LÃ¼tfen gÃ¶revlileri gÃ¶rmek iÃ§in bir etkinlik seÃ§in.</div>`;
    return;
  }

  // GÃ¶revleri ve baÄŸlÄ± personel bilgilerini Ã§ek
  const { data, error } = await supabaseClient
    .from("gorev_atamalari")
    .select("*, personeller(isim, yevmiye)")
    .eq("etkinlik_id", eid);

  if (error) {
    aList.innerHTML = "Veri yÃ¼kleme hatasÄ±!";
    return;
  }

  if (data.length === 0) {
    aList.innerHTML = `<div class="card" style="text-align:center; color:#94a3b8;">Bu etkinliÄŸe henÃ¼z kimse atanmamÄ±ÅŸ.</div>`;
    return;
  }

  // ÅÄ±k Liste TasarÄ±mÄ±
  aList.innerHTML = `<h3 style="margin-top:20px;">ğŸ“‹ Atanan Personel Listesi</h3>`;
  
  data.forEach(g => {
    aList.innerHTML += `
      <div class="list-item" style="background:#fff; border-radius:10px; margin-bottom:8px; padding:12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #16a34a;">
        <div>
          <strong>${g.personeller?.isim || 'Bilinmeyen Personel'}</strong> <br>
          <small style="color:#64748b;">ğŸ› ï¸ GÃ¶rev: ${g.gorev || 'Belirtilmedi'} | ğŸ’° ${g.personeller?.yevmiye || 0} TL</small>
        </div>
        <button class="btn-danger" style="padding:5px 10px; font-size:12px;" onclick="atamaSil('${g.id}')">KaldÄ±r</button>
      </div>
    `;
  });
}

// Atama Silme Fonksiyonu
async function atamaSil(id) {
  if(confirm("Bu personeli gÃ¶revden almak istediÄŸine emin misin?")) {
    const { error } = await supabaseClient.from("gorev_atamalari").delete().eq("id", id);
    if(!error) atamaListesiniYukle();
  }
}

// Chat Penceresini AÃ§/Kapat
function chatAcKapat() {
  const win = document.getElementById("ai-chat-window");
  win.style.display = win.style.display === "none" ? "flex" : "none";
}

// AI'ya Sorgu GÃ¶nder
async function aiSorguGonder() {
  const input = document.getElementById("ai-input");
  const msgBox = document.getElementById("ai-messages");
  const query = input.value.trim();
  
  if(!query) return;

  // KullanÄ±cÄ± mesajÄ±nÄ± ekrana yaz
  msgBox.innerHTML += `<div style="text-align:right; margin-bottom:10px;"><span style="background:#e0e7ff; padding:8px; border-radius:10px; display:inline-block;">${query}</span></div>`;
  input.value = "";
  msgBox.scrollTop = msgBox.scrollHeight;

  // --- N8N ENTEGRASYONU ---
  const N8N_WEBHOOK_URL = "https://yagizkarahan.app.n8n.cloud/webhook-test/Asistan"; // n8n'den aldÄ±ÄŸÄ±n URL'yi buraya yapÄ±ÅŸtÄ±r

  try {
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: "ai_command",
        text: query,
        user_email: currentUser.email,
        mekan_id: currentMekanId
      })
    });

    const data = await response.json();
    
    // AI CevabÄ±nÄ± ekrana yaz
    msgBox.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><span style="background:#f1f5f9; padding:8px; border-radius:10px; display:inline-block; border:1px solid #ddd;">${data.output || "Ä°ÅŸlem tamamlandÄ±."}</span></div>`;
    
    // EÄŸer AI bir veriyi gÃ¼ncellediyse listeyi tazele
    verileriYukle();
    
  } catch (err) {
    msgBox.innerHTML += `<div style="color:red; font-size:12px;">Hata:025</div>`;
  }
  msgBox.scrollTop = msgBox.scrollHeight;
}
// script.js dosyasÄ±nÄ±n EN ALTINA ekle

// Tab deÄŸiÅŸtirme fonksiyonu
function tabDegistir(tabId) {
    document.querySelectorAll('.yonetim-tab').forEach(el => el.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
    
    if(tabId === 'tab-personel') personelleriListele();
    if(tabId === 'tab-stok') stoklariListele();
}

// 1. Personel Listesi ve Manuel Puanlama
async function personelleriListele() {
    const { data, error } = await supabase.from('personeller').select('*');
    if (error) return console.error(error);

    const container = document.getElementById('personel-listesi-tablo');
    container.innerHTML = data.map(p => `
        <div style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${p.ad_soyad}</strong> - Yevmiye: ${p.yevmiye} TL <br>
                <small>Puan: ${p.puan || 5}/5</small>
            </div>
            <div>
                <button onclick="puanGuncelle('${p.id}', ${(p.puan || 5) - 1})" style="background:#ff4d4d; color:white; border:none; border-radius:3px;">-</button>
                <button onclick="puanGuncelle('${p.id}', ${(p.puan || 5) + 1})" style="background:#4CAF50; color:white; border:none; border-radius:3px;">+</button>
            </div>
        </div>
    `).join('');
}

// 2. PuanÄ± Supabase'e Yazma
async function puanGuncelle(id, yeniPuan) {
    const { error } = await supabase
        .from('personeller')
        .update({ puan: yeniPuan })
        .eq('id', id);
    
    if (!error) personelleriListele(); // Listeyi tazele
}

// Sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda listeyi yÃ¼kle (Opsiyonel)
// setTimeout(() => { personelleriListele(); }, 2000); 
async function puanDegistir(id, miktar) {
  // Ã–nce mevcut puanÄ± bulalÄ±m (Ekranda yazandan alabiliriz veya DB'den Ã§ekebiliriz)
  const puanElement = document.getElementById(`puan-${id}`);
  let mevcutPuan = parseInt(puanElement.innerText);
  let yeniPuan = mevcutPuan + miktar;

  // SÄ±nÄ±r koyalÄ±m (Ã–rn: 0 ile 10 arasÄ±)
  if (yeniPuan < 0) yeniPuan = 0;
  if (yeniPuan > 10) yeniPuan = 10;

  // Supabase GÃ¼ncelleme
  const { error } = await supabaseClient
    .from("personeller")
    .update({ puan: yeniPuan })
    .eq("id", id);

  if (error) {
    alert("Puan gÃ¼ncellenemedi: " + error.message);
  } else {
    // Ekranda anlÄ±k gÃ¼ncelle
    puanElement.innerText = yeniPuan;
  }
}
async function stokEkle() {
  const ad = document.getElementById("s_ad").value;
  const miktar = document.getElementById("s_miktar").value;
  
  if(!ad || !miktar) return alert("LÃ¼tfen tÃ¼m alanlarÄ± doldur!");

  const { error } = await supabaseClient.from("stok").insert([{
    urun_adi: ad,
    miktar: parseInt(miktar),
    mekan_id: currentMekanId
  }]);

  if(!error) {
    document.getElementById("s_ad").value = "";
    document.getElementById("s_miktar").value = "";
    stoklariYukle();
  }
}

async function stoklariYukle() {
  const { data, error } = await supabaseClient
    .from("stok")
    .select("*")
    .eq("mekan_id", currentMekanId)
    .order('urun_adi', { ascending: true });

  const sList = document.getElementById("s_liste");
  if (error) return sList.innerHTML = "Hata!";

  // script.js iÃ§indeki stoklariYukle fonksiyonunun ilgili kÄ±smÄ±
sList.innerHTML = data.map(s => `
  <div class="list-item">
    <div>
      <strong>${s.urun_adi}</strong> <br>
      <small>Stok: <b id="stok-miktar-${s.id}" style="${s.miktar <= s.kritik_esik ? 'color:red' : ''}">${s.miktar} adet</b></small>
    </div>
    <div>
      <button class="btn-success" style="padding:5px 10px;" onclick="stokGuncelle('${s.id}', 1)">+</button>
      <button class="btn-danger" style="padding:5px 10px;" onclick="stokGuncelle('${s.id}', -1)">-</button>
      <button class="btn-edit" style="padding:5px 10px;" onclick="stokManuelGuncelle('${s.id}', '${s.urun_adi}', ${s.miktar})">âœï¸ DÃ¼zenle</button>
      <button class="btn-danger" style="padding:5px 10px; background:#ef4444;" onclick="stokSil('${s.id}', '${s.urun_adi}')">ğŸ—‘ï¸</button>
    </div>
  </div>
`).join('');

}

// MiktarÄ± hÄ±zlÄ±ca artÄ±rÄ±p azaltmak iÃ§in
async function stokGuncelle(id, fark) {
  // Ã–nce mevcut miktarÄ± bulup Ã¼zerine ekleyelim (Pratik yÃ¶ntem)
  const { data } = await supabaseClient.from("stok").select("miktar").eq("id", id).single();
  await supabaseClient.from("stok").update({ miktar: data.miktar + fark }).eq("id", id);
  stoklariYukle();
}
async function stokManuelGuncelle(id, urunAdi, mevcutMiktar) {
  const yeniMiktar = prompt(`${urunAdi} iÃ§in yeni stok miktarÄ±nÄ± girin:`, mevcutMiktar);
  
  // Ä°ptal edilirse veya boÅŸ bÄ±rakÄ±lÄ±rsa iÅŸlem yapma
  if (yeniMiktar === null || yeniMiktar === "") return;

  const miktarSayi = parseInt(yeniMiktar);
  if (isNaN(miktarSayi)) return alert("LÃ¼tfen geÃ§erli bir sayÄ± girin!");

  const { error } = await supabaseClient
    .from("stok")
    .update({ miktar: miktarSayi })
    .eq("id", id);

  if (error) {
    alert("GÃ¼ncelleme hatasÄ±: " + error.message);
  } else {
    stoklariYukle(); // Listeyi tazele
  }
}
async function stokSil(id, urunAdi) {
  if (confirm(`"${urunAdi}" adlÄ± Ã¼rÃ¼nÃ¼ tamamen silmek istediÄŸinize emin misiniz?`)) {
    const { error } = await supabaseClient
      .from("stok")
      .delete()
      .eq("id", id);

    if (error) {
      alert("Silme hatasÄ±: " + error.message);
    } else {
      stoklariYukle(); // Listeyi gÃ¼ncelle
    }
  }
}

async function personelDuzenle(id, eskiIsim, eskiYevmiye, eskiTel) {
  const yeniIsim = prompt("Personel AdÄ± SoyadÄ±:", eskiIsim);
  if (!yeniIsim) return;

  const yeniYevmiye = prompt("Yevmiye (TL):", eskiYevmiye);
  if (!yeniYevmiye) return;

  const yeniTel = prompt("Telefon:", eskiTel);

  const { error } = await supabaseClient
    .from("personeller")
    .update({ 
      isim: yeniIsim, 
      yevmiye: parseInt(yeniYevmiye),
      telefon: yeniTel 
    })
    .eq("id", id);

  if (!error) {
    verileriYukle();
  } else {
    alert("GÃ¼ncelleme hatasÄ±: " + error.message);
  }
}
function personelFiltrele() {
  const aranan = document.getElementById("p_ara").value.toLowerCase();
  const kartlar = document.querySelectorAll("#p_liste .list-item");

  kartlar.forEach(kart => {
    const isim = kart.querySelector("strong").innerText.toLowerCase();
    if (isim.includes(aranan)) {
      kart.style.display = "flex";
    } else {
      kart.style.display = "none";
    }
  });
}
let aktifPersonel = null;

async function personelGirisYap() {
  const tel = document.getElementById("p_login_tel").value.trim();
  if(!tel) return alert("Telefon girin!");

  // VeritabanÄ±nda bu telefonla kayÄ±tlÄ± personel var mÄ±?
  const { data, error } = await supabaseClient
    .from("personeller")
    .select("*")
    .eq("telefon", tel)
    .single();

  if (error || !data) {
    return alert("Bu numara ile kayÄ±tlÄ± personel bulunamadÄ±!");
  }

  aktifPersonel = data;
  document.getElementById("personelLoginScreen").style.display = "none";
  document.getElementById("personelPanel").style.display = "flex";
  document.getElementById("p_selam").innerText = `Merhaba, ${aktifPersonel.isim}`;
  personelGorevleriniYukle();
  // personelGirisYap fonksiyonu iÃ§inde en alta ekle:
  duyurulariYuklePersonel();

}

async function personelGorevleriniYukle() {

  const list = document.getElementById("p_gorev_listesi");
  list.innerHTML = "YÃ¼kleniyor...";

  // 1. ADIM: Sadece gÃ¶rev atamalarÄ±nÄ± Ã§ek (Ä°liÅŸki kurmadan)
  const { data: atamalar, error: atamaHata } = await supabaseClient
    .from("gorev_atamalari")
    .select("*")
    .eq("personel_id", aktifPersonel.id);

  if (atamaHata) {
    console.error("Atama Ã§ekme hatasÄ±:", atamaHata);
    list.innerHTML = "GÃ¶revler alÄ±namadÄ±.";
    return;
  }

  if (!atamalar || atamalar.length === 0) {
    list.innerHTML = "YaklaÅŸan gÃ¶reviniz bulunmuyor.";
    return;
  }

  list.innerHTML = ""; // Temizle

  // 2. ADIM: Her atama iÃ§in etkinlik bilgilerini tek tek bul
  for (const atama of atamalar) {
    const { data: etkinlik, error: eHata } = await supabaseClient
      .from("etkinlikler")
      .select("etkinlik_turu, tarih")
      .eq("id", atama.etkinlik_id)
      .single();

    const eAd = etkinlik ? etkinlik.etkinlik_turu : "Bilinmeyen Etkinlik";
    const eTarih = etkinlik ? etkinlik.tarih : "-";

    // Ekrana bas
    list.innerHTML += `
      <div class="card" style="border-left: 30px solid #2563eb; margin-bottom: 12px; padding: 100px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <strong style="color: #1e293b; font-size:50px;">${eAd}</strong> <br>
        <small style="color: #64748b; font-size:45px">ğŸ“… ${eTarih}</small> <br>
        <p style="margin: 75px 250; font-size:40px;">ğŸ› ï¸ <b>GÃ¶rev:</b> ${atama.gorev_adi}</p>
        <button class="btn-danger" style="padding:50px 200px; font-size:25px" onclick="iptalEt('${atama.id}', '${eAd}')">
          âŒ GelemeyeceÄŸim
        </button>
      </div>`;
  }
}




async function iptalEt(gorevId, etkinlikAdi) {
  if(!confirm(`${etkinlikAdi} gÃ¶revini iptal etmek istediÄŸine emin misin?`)) return;

  // YÃ¶neticiye bildirim gÃ¶nder
  await supabaseClient.from("bildirimler").insert([{
    mekan_id: aktifPersonel.mekan_id,
    mesaj: `${aktifPersonel.isim}, "${etkinlikAdi}" etkinliÄŸine gelemeyeceÄŸini bildirdi!`,
    okundu: false
  }]);

  // GÃ¶revi sil
  await supabaseClient.from("gorev_atamalari").delete().eq("id", gorevId);

  alert("Ä°ptal bildirildi. YÃ¶neticine bilgi verildi.");
  personelGorevleriniYukle();
}
function loginEkranDegistir(mod) {
  // YÃ¶netici giriÅŸ ekranÄ± ve Personel giriÅŸ ekranÄ± divlerini al
  const adminDiv = document.getElementById("loginScreen"); 
  const personelDiv = document.getElementById("personelLoginScreen");

  if (mod === 'admin') {
    personelDiv.style.display = "none";
    adminDiv.style.display = "block";
  } else {
    adminDiv.style.display = "none";
    personelDiv.style.display = "block";
  }
}

async function duyurulariYuklePersonel() {
  const { data, error } = await supabaseClient
    .from("duyurular")
    .select("*")
    .eq("mekan_id", aktifPersonel.mekan_id)
    .order('created_at', { ascending: false })
    .limit(3); // En son yayÄ±nlanan 3 duyuruyu gÃ¶ster

  const duyuruDiv = document.getElementById("p_duyuru_alani");
  
  if (error || !data || data.length === 0) {
    duyuruDiv.innerHTML = ""; // Duyuru yoksa boÅŸ kalsÄ±n
    return;
  }

  duyuruDiv.innerHTML = data.map(d => `
    <div class="card" style="background: #fff3cd; border-left: 5px solid #f59e0b; padding: 15px; margin-bottom: 10px; border-radius: 8px; color: #92400e;">
      <strong>ğŸ“¢ Duyuru:</strong> <br>
      <span style="font-size: 14px;">${d.mesaj}</span> <br>
      <small style="font-size: 10px; color: #b45309; display: block; margin-top: 5px;">
        ${new Date(d.created_at).toLocaleDateString('tr-TR')}
      </small>
    </div>
  `).join('');
}
async function iptalBildirimleriniYukle() {
  const liste = document.getElementById("iptal-listesi");
  if (!liste) return;

  const { data, error } = await supabaseClient
    .from("bildirimler")
    .select("*")
    .eq("mekan_id", currentMekanId)
    .eq("okundu", false)
    .order('created_at', { ascending: false });

  if (error || !data || data.length === 0) {
    liste.innerHTML = "<p style='color:gray;'>Yeni iptal bildirimi yok.</p>";
    return;
  }

  liste.innerHTML = data.map(b => `
    <div style="padding:10px; border-bottom:1px solid #fee2e2; background:#fff5f5; border-radius:5px; margin-bottom:5px; font-size:13px;">
      <strong>âš ï¸ Ä°ptal:</strong> ${b.mesaj}
    </div>
  `).join('');
}
async function duyuruYayinla() {
  const mesaj = document.getElementById("duyuru_metni").value.trim();
  
  if (!mesaj) return alert("LÃ¼tfen bir mesaj yazÄ±n!");

  const { error } = await supabaseClient
    .from("duyurular") 
    .insert([{
      mekan_id: currentMekanId,
      mesaj: mesaj
    }]);

  if (!error) {
    alert("ğŸš€ Duyuru tÃ¼m personellere gÃ¶nderildi!");
    document.getElementById("duyuru_metni").value = "";
    // Kendi ekranÄ±mÄ±zdaki listeyi de tazele (isteÄŸe baÄŸlÄ±)
  } else {
    alert("Hata oluÅŸtu: " + error.message);
  }
}
function sayfaGoster(sayfaId) {
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");

  let hedef = document.getElementById(sayfaId);
  if (!hedef) {
    hedef = document.getElementById('page-' + sayfaId);
  }

  if (hedef) {
    hedef.style.display = "block";
  }

  if(sayfaId === 'atama') {
    atamaListesiniYukle();
  }
  if(sayfaId === 'stok') {
    stoklariYukle();
  }
  if (sayfaId === 'duyuru') {
    iptalBildirimleriniYukle();
  }
}

async function bildirimleriTemizle() {
  const { error } = await supabaseClient
    .from("bildirimler")
    .update({ okundu: true })
    .eq("mekan_id", currentMekanId)
    .eq("okundu", false);

  if (!error) {
    iptalBildirimleriniYukle();
  }
}

async function whatsappListeOlustur() {
  const { data: personeller } = await supabaseClient
    .from("personeller")
    .select("isim, telefon")
    .eq("mekan_id", currentMekanId);

  if (!personeller || personeller.length === 0) {
    return alert("Personel bulunamadÄ±!");
  }

  let liste = "PERSONEL LÄ°STESÄ°:\n\n";
  personeller.forEach(p => {
    liste += `${p.isim} - ${p.telefon || 'Tel yok'}\n`;
  });

  navigator.clipboard.writeText(liste).then(() => {
    alert("Liste panoya kopyalandÄ±! WhatsApp'a yapÄ±ÅŸtÄ±rabilirsiniz.");
  }).catch(() => {
    alert("Kopyalama baÅŸarÄ±sÄ±z. Liste:\n\n" + liste);
  });
}

// --- MESAJLAÅMA MOTORU V1 ---
let mevcutChatModu = 'ozel'; 
let seciliAdminHedefId = null; 

// 1. PERSONEL: MesajlarÄ± ve GruplarÄ± YÃ¼kle
async function mesajlariYukle() {
    if (!aktifPersonel) return;
    const pencere = document.getElementById("p-chat-penceresi");
    const grupSecici = document.getElementById("p-chat-grup-secici");
    
    let sorgu = supabaseClient.from("mesajlar").select(`*, personeller(isim)`);

    if (mevcutChatModu === 'ozel') {
        // Personel-Admin Ã–zel YazÄ±ÅŸma
        sorgu = sorgu.or(`and(gonderen_id.eq.${aktifPersonel.id},alici_id.eq.admin),alici_id.eq.${aktifPersonel.id}`);
    } else {
        // Grup YazÄ±ÅŸmasÄ±
        const eId = grupSecici.value;
        if (!eId) { pencere.innerHTML = "Grup seÃ§iniz..."; return; }
        sorgu = sorgu.eq('grup_id', eId).eq('alici_id', 'grup');
    }

    const { data: mesajlar } = await sorgu.order('created_at', { ascending: true });
    pencere.innerHTML = mesajlar.map(m => mesajBaloncuÄŸuOlustur(m, aktifPersonel.id)).join('');
    pencere.scrollTop = pencere.scrollHeight;
}

// 2. YÃ–NETÄ°CÄ°: MesajlarÄ± YÃ¼kle
async function adminMesajlariYukle() {
    if (!seciliAdminHedefId) return;
    const pencere = document.getElementById("admin-chat-penceresi");
    
    let sorgu = supabaseClient.from("mesajlar").select(`*, personeller(ad_soyad)`);

    if (adminSeciliTip === 'ozel') {
        sorgu = sorgu.or(`and(gonderen_id.eq.${seciliAdminHedefId},alici_id.eq.admin),and(alici_id.eq.${seciliAdminHedefId},gonderen_id.is.null)`);
    } else {
        sorgu = sorgu.eq('grup_id', seciliAdminHedefId).eq('alici_id', 'grup');
    }

    const { data: mesajlar } = await sorgu.order('created_at', { ascending: true });
    pencere.innerHTML = mesajlar.map(m => mesajBaloncuÄŸuOlustur(m, null)).join(''); // Admin iÃ§in gonderen_id null
    pencere.scrollTop = pencere.scrollHeight;
}

// Ortak Baloncuk TasarÄ±mÄ±
function mesajBaloncuÄŸuOlustur(m, karsilastirmaId) {
    const benMiyim = m.gonderen_id === karsilastirmaId; // Admin iÃ§in karsilastirmaId null gelir
    const isim = m.personeller ? m.personeller.ad_soyad : "YÃ¶netici";
    return `
        <div style="text-align: ${benMiyim ? 'right' : 'left'}; margin-bottom: 8px;">
            <small style="font-size:10px; color:#666;">${benMiyim ? 'Siz' : isim}</small><br>
            <div style="display:inline-block; padding:8px 12px; border-radius:12px; background:${benMiyim ? '#6366f1':'#e2e8f0'}; color:${benMiyim ? 'white':'black'}; max-width:80%;">
                ${m.mesaj}
            </div>
        </div>`;
}




</script>
</body>
</html>
